@using BreakingNomad.Shared.Services
@using BreakingNomad.Ui.Components.MenuMaker.Models
@using BreakingNomad.Ui.Helpers
@using Bumbershoot.Utilities.Helpers
@using BreakingNomad.Ui.Components


<div >
  @foreach (var tag in MappedItems)
  {
    <span class="badge bg-secondary" style="background-color: @ToColor(tag)">
      @tag.Name
      <span @onclick="() => RemoveItem(tag)" class="oi oi-delete"></span>
    </span>
  }
  <a @onclick="Add">
    <span class="badge rounded-pill bg-primary-subtle mx-3">

      <span class="oi oi-plus"></span>

    </span>
  </a>
  <ItemPickerModal @ref="Modal">
    <Title>Please select a meal</Title>
    <Body>
    @foreach (var tag in AllowedItems.OrEmpty().Where(x => !MappedItems.Contains(x)).OrderByDescending(x => x.MealType == MealType).ThenBy(x => x.MealType).ThenBy(x => x.Name))
    {
      <a @onclick="() => AddToList(tag)">
        <span class="badge bg-secondary mx-3" style="background-color: @ToColor(tag)">
          @tag.Name
        </span>
      </a>
    }
    </Body>
    <Footer>
      <button type="button" @onclick="CloseModal" class="btn btn-primary">Close</button>
    </Footer>
  </ItemPickerModal>

</div>

@code {

  private ItemPickerModal? Modal { get; set; }

  [Parameter]
  public Action? CallBack { get; set; }

  [Parameter]
  public MealsOfTheDay? SelectedItems { get; set; }

  [Parameter]
  public List<MealRecipe>? AllowedItems { get; set; } 
  
  [Parameter]
  public MealType? MealType { get; set; }

  public List<MealRecipe> MappedItems { get; set; } = new();
  
  protected override void OnParametersSet()
  {
    var selectedItemsOptions = SelectedItems?.Options?.ToList();
    if (selectedItemsOptions != null) {
      MappedItems = AllowedItems.OrEmpty().Where(x => selectedItemsOptions?.Contains(x.Key) == true).ToList();
    }
  }
  
  private void RemoveItem(MealRecipe tag)
  {
    MappedItems.Remove(tag);
    SetSelected();
  }

  private void SetSelected()
  {
    if (SelectedItems != null)
    {
      var list = MappedItems.Select(x => x.Key);
      SelectedItems.SetOption(list);
      Console.Out.WriteLine("Setting " + SelectedItems.Options.StringJoin());
      CallBack?.Invoke();
    }
  }

  private string ToColor(MealRecipe tag)
  {
    return tag.MealType.ToColor();
  }

  private void Add()
  {
    Modal?.Open();
  }

  private void CloseModal()
  {
    Modal?.Close();
  }

  private void AddToList(MealRecipe tag)
  {
    MappedItems.Add(tag);
    SetSelected();
    Modal?.Close();
  }

}
